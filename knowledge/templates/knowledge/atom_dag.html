{% extends 'site_base.html' %}
{% load atom %}
{% load comments %}

{% block jquery_src %}http://code.jquery.com/jquery-1.11.1.min.js{% endblock %}

{% block extra_style %}
<style>
#viewport.linkable{
  cursor:pointer;
}
</style>
{% endblock %}

{% block extra_script %}
<script src="/static/knowledge/arbor.js"></script>
<script src="/static/knowledge/arbor-graphics.js"></script>
<script src="/static/knowledge/arbor-tween.js"></script>
<script type="text/javascript">
(function($){

  Renderer = function(canvas){
    canvas = $(canvas).get(0)
    var dom = $(canvas)
    var ctx = canvas.getContext("2d")
    var particleSystem = null
    var gfx = arbor.Graphics(canvas)

    var that = {
      init:function(system){
      particleSystem = system
      particleSystem.screen({size:{width:dom.width(), height:dom.height()},
                    padding:[36,60,36,60]})
        //step:.02}) // have the ‘camera’ zoom somewhat slowly as the graph unfolds 
       //$(window).resize(that.resize)
       //that.resize()
      
       that.initMouseHandling()
      },
    
      redraw:function(){
        ctx.clearRect(0,0, canvas.width, canvas.height)
        
        particleSystem.eachEdge(function(edge, pt1, pt2){
          // edge: {source:Node, target:Node, length:#, data:{}}
          // pt1:  {x:#, y:#}  source position in screen coords
          // pt2:  {x:#, y:#}  target position in screen coords

          // draw a line from pt1 to pt2
          var style_of_edge = {
            
          }

          ctx.strokeStyle = "rgba(255,0,0, .333)"
          ctx.lineWidth = 1 + 4*edge.data.weight
          ctx.beginPath()
          ctx.moveTo(pt1.x, pt1.y)
          ctx.lineTo(pt2.x, pt2.y)
          ctx.stroke()

          var th = 8
          ctx.fillStyle = "black"
          ctx.font = String(th) + "px Arial"
          var tmes = ctx.measureText(edge.data.verb)
          ctx.fillText(edge.data.verb,
            (pt1.x+pt2.x)/2-tmes.width/2,
            (pt1.y+pt2.y)/2+th/2);
        })

        particleSystem.eachNode(function(node, pt){
            var style_of_label = {
                'primary' : 'blue',
                'success' : 'green',
                'danger' : 'red',
                'info' : '#9999FF',
                'default' : 'black',
            };


            var w = Math.max(20, 20+gfx.textWidth(node.data.label) )
            gfx.oval(pt.x-w/2, pt.y-w/2, w, w, {fill:style_of_label[node.data.type]})
            gfx.text(node.data.label, pt.x, pt.y+7, {color:"white", align:"center", font:"Arial", size:12})
            gfx.text(node.data.label, pt.x, pt.y+7, {color:"white", align:"center", font:"Arial", size:12})
          /*
          var th = 12
          ctx.font = String(th) + "px Arial"
          var style_of_label = {
                'primary' : 'blue',
                'success' : 'green',
                'danger' : 'red',
                'info' : 'blue',
                'default' : 'black',
            };

          var tmes = ctx.measureText(node.data.label)
          var tw = tmes.width
          var w = tw + 20
          var h = th + 10
          ctx.fillStyle = style_of_label[node.data.type];
          ctx.fillRect(pt.x-w/2, pt.y-h/2, w, h)
          ctx.fillStyle = "white"
          ctx.fillText(node.data.label, pt.x-tw/2, pt.y+th/2);
          */
        })    			
      },
      
      resize:function(){
        var w = $(window).width(),
            h = $(window).height();
        canvas.width = w; canvas.height = h // resize the canvas element to fill the screen
        particleSystem.screenSize(w,h) // inform the system so it can map coords for us
        that.redraw()
      },

    	initMouseHandling:function(){
        // no-nonsense drag and drop (thanks springy.js)
      	selected = null;
      	nearest = null;
      	var dragged = null;
        var oldmass = 1
        var scrolling = false
        var old_pos = null

            
        $(canvas).mousedown(function(e){
      		var pos = $(this).offset();
      		var p = {x:e.pageX-pos.left, y:e.pageY-pos.top}
            var old_pos = p;
      		selected = particleSystem.nearest(p);
            selected = (selected.distance < 50) ? selected : null

      		if (selected && selected.node !== null){
                window.open(window.location.host + selected.node.data.url)
            } else {
                scrolling = true
            }

      		return false
      	});

      	$(canvas).mousemove(function(e){
            var old_nearest = nearest && nearest.node._id
      		var pos = $(this).offset();
      		var s = {x:e.pageX-pos.left, y:e.pageY-pos.top};

      		nearest = particleSystem.nearest(s);
            nearest = (nearest.distance < 50) ? nearest : null

            if (nearest) {
                dom.addClass('linkable')
                window.status = window.location.host + nearest.node.data.url
            } else {
                dom.removeClass('linkable')
            }

            if (scrolling) {
                var nearest = particleSystem.nearest(s);
                
                var damp = 0.01
                nearest.node.p.x += (s.x - old_pos.x)*damp
                nearest.node.p.y += (s.y - old_pos.y)*damp
            }

            old_pos = s

            return false
      	});

      	$(window).bind('mouseup',function(e){
            scrolling = false
        });

      },
            
    }
  
    return that
  }
 
   $(document).ready(function(){
      var sys = arbor.ParticleSystem(100, 1000, 0.5, 55)
      sys.renderer = Renderer("#viewport") // our newly created renderer will have its .init() method called shortly by sys...

    {% for atom in atoms %}
var atom_{{atom.id}} = sys.addNode("{{ atom }}", 
      { url : "{% url 'atom_detail' atom.id %}",
        label : "{{ atom.slug }}",
        type : '{{ atom.typ.bootstrap_label }}' });
    {% endfor %}

    {% for atom in atoms %}
        {% for rel in atom.from_atoms.all %}
            sys.addEdge(atom_{{ atom.id }}, atom_{{ rel.to_atom.id }},
                { verb : "{{ rel.typ.slug }}" })
        {% endfor %}
    {% endfor %}
      
    });

})(this.jQuery);
</script>
{% endblock %}

{% block body %}
<canvas id="viewport" width="800" height="600"></canvas>
{% endblock %}
