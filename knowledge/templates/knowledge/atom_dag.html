{% extends 'site_base.html' %}
{% load atom %}
{% load comments %}

{% comment %}
{% block jquery_src %}http://code.jquery.com/jquery-1.11.1.min.js{% endblock %}
{% endcomment %}

{% block extra_style %}
<style>
#canvas {
    width:100%;
    height:100%;
}
#canvas.linkable{
  cursor:pointer;
}
</style>
{% endblock %}

{% block extra_script %}
<script src="/static/knowledge/easeljs.min.js"></script>
<script type="text/javascript">

function LightenDarkenColor(col, amt) {
  
    var usePound = false;
  
    if (col[0] == "#") {
        col = col.slice(1);
        usePound = true;
    }
 
    var num = parseInt(col,16);
 
    var r = (num >> 16) + amt;
 
    if (r > 255) r = 255;
    else if  (r < 0) r = 0;
 
    var b = ((num >> 8) & 0x00FF) + amt;
 
    if (b > 255) b = 255;
    else if  (b < 0) b = 0;
 
    var g = (num & 0x0000FF) + amt;
 
    if (g > 255) g = 255;
    else if (g < 0) g = 0;
 
    return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
  
}

   $(document).ready(function(){

    var canvas = $('#canvas')[0];
    var ctx = canvas.getContext('2d');

    function initCanvasArea(cnv) {
        cnv.width = window.innerWidth;
        cnv.height = window.innerHeight;
    }

    var graph = {
    {% for atom in atoms %}
        {{atom.id}} : {
            label : "{{ atom.slug }}",
            type : "{{ atom.typ.bootstrap_label }}",
            pos : { x: 0, y: 0 },
            plotted : false,
            url : "{% url 'atom_detail' atom.id %}",
            name : "{{ atom }}",
            incoming: { 
                {% for rel in atom.from_atoms.all %}
                    {{ rel.to_atom.id }} : "{{ rel.typ.slug }}",
                {% endfor %}
                },
            outgoing: { 
                {% for rel in atom.to_atoms.all %}
                    {{ rel.from_atom.id }} : "{{ rel.typ.slug }}",
                {% endfor %}
                },
        },
    {% endfor %}
    };

    var no_dep = new Array();

    function has_nonplotted_incoming(atom) {
        var a = graph[atom];
        var nonplottedincoming = false;

        for(var oatom in a.incoming) {
            if (!graph[oatom].plotted) 
                nonplottedincoming = true;
        }

        return nonplottedincoming;
    }

    for (var atom in graph) {
        if (!has_nonplotted_incoming(atom))
            no_dep.push(atom);
    }
    var ordered = new Array();

    while(no_dep.length > 0) {
        var atom = no_dep[0];
        no_dep.shift();
        
        if (graph[atom].plotted)
            continue;

        ordered.push(atom);

        graph[atom].plotted = true;
        for (var oatom in graph[atom].outgoing) {
            if (!has_nonplotted_incoming(oatom)) {
                no_dep.push(oatom);
            }
        }
    }

    var xfree = new Array();

    for (var i = 0; i < ordered.length; i++) {
        var atom = ordered[i];
        var maxx = -1;
        
        for (var oatom in graph[atom].incoming) {
            if (graph[oatom].pos.x > maxx)
                maxx = graph[oatom].pos.x;
        }

        var current_x = maxx + 1;

        if (current_x == xfree.length)
        {
            xfree.push(0);
        }

        var current_y = xfree[current_x];

        graph[atom].pos.x = current_x;
        graph[atom].pos.y = current_y;

        xfree[current_x]++;
    }

    var stage = new createjs.Stage("canvas");

    window.onresize = function(e) {
        initCanvasArea(canvas);
        stage.update();
    };

    stage.enableMouseOver(10);

    var WIDTH = 100;
    var SEP = 100;
    var MARGIN = 50;
    var INNER_MARGIN = 5;

    var colors = {
        default: "#858585",
        success: "#5cb85c",
        primary: "#337ab7",
        info: "#5bc0de",
        warning: "#f0ad4e",
        danger: "#d9534f",
    };

    for (var atom in graph) {
        var x = graph[atom].pos.x;
        var y = graph[atom].pos.y;

        var container = new createjs.Container();
        container.x = MARGIN + (WIDTH+SEP)*x + SEP/2;
        container.y = MARGIN + (WIDTH+SEP)*y + SEP/2;
        container.setBounds(0, 0, WIDTH, WIDTH);

        var url = graph[atom].url;

        container.on("click", function(e, url) {
            window.open(url);
        }, null, false, url);
        container.on("mouseover", function(e, url) {
            $(canvas).addClass('linkable');
            window.status = url;
        }, null, false, url);
        container.on("mouseout", function(e) {
            $(canvas).removeClass('linkable');
            window.status = "";
        }, null, false, url);

        var rect = new createjs.Shape();
        var color = colors[graph[atom].type];

                var text = new createjs.Text();
        text.lineWidth = WIDTH - 2*INNER_MARGIN;
        text.set({
            text: graph[atom].name,
            font: "bold 12px arial",
            color: "white", 
            textAlign: "center",
        });
        var b = text.getBounds();
        text.x = WIDTH/2;
        text.y = WIDTH/2 - b.height/2;

        rect.graphics
            .beginStroke(LightenDarkenColor(color,-20))
            .setStrokeStyle(3)
            .beginFill(color)
            .drawRoundRectComplex(0, text.y - INNER_MARGIN, WIDTH, b.height +
                    2*INNER_MARGIN, 5, 5, 5, 5);

        container.addChild(rect);


        container.addChild(text);
        stage.addChild(container);

        for (var oatom in graph[atom].outgoing) {
            var edge = new createjs.Shape();

            var ox = graph[oatom].pos.x;
            var oy = graph[oatom].pos.y;

            var rx = MARGIN + (WIDTH+SEP)*x + SEP/2 + WIDTH;
            var ry = MARGIN + (WIDTH+SEP)*y + SEP/2 + WIDTH/2;
            var rox = MARGIN + (WIDTH+SEP)*ox + SEP/2;
            var roy = MARGIN + (WIDTH+SEP)*oy + SEP/2 + WIDTH/2;

            edge.graphics
                .beginStroke(createjs.Graphics.getRGB(0, 0, 0))
                .moveTo(rx, ry).lineTo(rox, roy);

            var radian = Math.atan2( (roy-ry), (rox-rx) );
            var degree = radian / Math.PI * 180;

            var arrow = new createjs.Shape();
            arrow.graphics
                .beginFill(createjs.Graphics.getRGB(0, 0, 0))
                .moveTo(5, 5).lineTo(0,0).lineTo(5,-5);
            arrow.x = rx;
            arrow.y = ry;
            arrow.rotation = degree;

            var text = new createjs.Text(graph[atom].outgoing[oatom],
                    "10px arial", "red");
            var b = text.getBounds();
            text.x = (rx+rox)/2 - b.width/2;
            text.y = (ry+roy)/2;

            text.rotation = degree;

            stage.addChild(text);
            stage.addChild(arrow);
            stage.addChild(edge);
        }
    }

    initCanvasArea(canvas);
    stage.update();

    canvas.addEventListener("mousewheel", MouseWheelHandler, false);
    canvas.addEventListener("DOMMouseScroll", MouseWheelHandler, false);

    var zoom;

    function MouseWheelHandler(e) {
        if(Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)))>0)
            zoom=1.01;
        else
            zoom=1/1.01;
            var local = stage.globalToLocal(stage.mouseX, stage.mouseY);
        stage.regX=local.x;
        stage.regY=local.y;
        stage.x=stage.mouseX;
        stage.y=stage.mouseY;	
        stage.scaleX=stage.scaleY*=zoom;

        stage.update();
    }

    stage.addEventListener("stagemousedown", function(e) {
        var offset={x:stage.x-e.stageX,y:stage.y-e.stageY};
        stage.addEventListener("stagemousemove",function(ev) {
            stage.x = ev.stageX+offset.x;
            stage.y = ev.stageY+offset.y;
            stage.update();
        });
        stage.addEventListener("stagemouseup", function(){
            stage.removeAllEventListeners("stagemousemove");
        });
    }); 

});
</script>
{% endblock %}

{% block body_base %}
<!--<canvas id="viewport" width="800" height="600"></canvas>-->
<div class="container-fluid">
    <canvas id="canvas" width="1000" height="600"></canvas>
</div>
{% endblock %}
